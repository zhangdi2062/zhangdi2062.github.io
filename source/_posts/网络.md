---
title: 网络
tags:
  - js
  - node
  - webSocket
categories:
  - 前端
date: 2024-03-20 21:04:54
---

## webSocket

### 前端

事件：

```javascript
open;
close;
error;
message;
```

使用方式:

```javascript
const ws = new WebSocket("ws://localhost:8080");
ws.addEventListener("open", function () {});
// 当点击按钮时，发送一条消息
document.querySelector("button").onclick = function () {
  // send接收字符串
  ws.send("hello");
};
ws.addEventListener("message", function (event) {
  // 接收后端client.send发送的消息
  console.log(event.data);
});
```

### 后端

事件：

```javascript
open;
close;
error;
message;
connection;
```

使用方式：

```javascript
const WebSocket = require("ws");
const server = new WebSocket.Server({ port: 8080 });
server.on("connection", function (ws) {
  ws.on("message", function (message) {
    // 接收前端ws.send发送的消息
    console.log("received: %s", message);
    server.clients.forEach(function each(client) {
      // 广播消息
      if (client.readyState === WebSocket.OPEN) {
        client.send(message);
      }
    });
  });
});
```

## 网络模型

### OSI 七层参考模型 & TCP/IP 四层模型

![网络模型](网络模型.png)

#### 物理层

- 信道
  - 有线信道，明线，逐渐被电缆取代
  - 有线信道，对称电缆，由多对双绞线组成
  - 有线信道，同轴电缆，电视广播、长途电话、局域网
  - 有线信道，光纤
  - 无线信道，无线电波，蓝牙、WiFi、蜂窝网络

**物理层传输比特流**

#### 数据链路层

通过 Mac 地址来识别接收者和发送者，并对物理层传输的比特流进行分组，每个分组称为帧。
通过广播的方式来传播，在局域网内所有计算机都能收到消息

windows 下查看 Mac 地址：`ipconfig /all`
Mac 下查看 Mac 地址：`ifconfig`

#### 网络层

- 寻址：依靠 ip

- 路由

ip 协议在这一层，分为 ipv6 和 ipv4，ipv4 的地址是 32 位的，ipv6 的地址是 128 位的，ipv4 的地址已经不够用了，所以出现了 ipv6

#### 传输层

- 定义端口号，控流和校验

- TCP：面向连接的协议，可靠，因为有三次握手四次挥手，但会降低效率

- UDP：无连接的协议，不可靠，但效率高，常用于直播、游戏

这一次叫做数据段

#### 会话层

这一层经常被叫做报文

断点下载：会话层包含检查点的机制，可以从断点处继续下载

会话层是在发送方和接收方之间进行通信时创建、维持、终止或端口连接的地方

#### 表示层

这一层经常被叫做报文

- 在网络中的翻译官，负责数据的格式化，如压缩、加密、解密
- 对图片文件等格式进行解码和编码

#### 应用层

这一层经常被叫做报文

- 为应用程序提供服务，如 HTTP、FTP、邮件协议 SMTP、域名系统 DNS、WebSocket 长连接、SSH 远程登录

### TCP 三次握手

![TCP三次握手](TCP三次握手.png)

### TCP 四次挥手

![TCP四次挥手](TCP四次挥手.png)

### 浏览器输入 url 时会发生什么

#### DNS 解析

1. 浏览器自身 DNS
2. 操作系统 DNS
3. 本地 host 文件
4. 域名服务器
5. 根域名服务器
6. 顶级域名服务器
7. 权威域名服务器（当有 CDN 时，不再找权威域名，而是从 CDN 专用的 DNS 服务器去解析）

#### 什么时候会发起 options 请求：

1. 跨域时，浏览器会先发起 options 请求，询问服务器是否允许跨域，服务器返回允许的方法，浏览器再发起真正的请求。
2. 有自定义请求头

#### 缓存

##### 强缓存

- Expires：过期时间，由服务器返回，是一个绝对时间，即使客户端的时间和服务器的时间不一致，也不影响缓存的使用
- Cache-Control：通过指定指令来实现缓存机制
  - max-age=3600，表示缓存的有效时间为 3600 秒，时间是相对于请求的时间，优先级高于 Expires
  - no-cache：不使用强缓存，使用协商缓存
  - no-store：不使用任何缓存，每次都请求服务器
  - public：响应可以被任何对象缓存
  - private：响应只能被单个用户缓存，不能作为共享缓存，如用户的本地浏览器缓存

强缓存第一次从 disk 缓存中读取，第二次从浏览器内存中读取，内存读取速度更快

##### 协商缓存

- Last-Modified：服务器在响应请求时，告诉浏览器资源的最后修改时间，浏览器下次请求时，会带上 If-Modified-Since，服务器会比较这个时间和资源的最后修改时间，如果一致，返回 304，浏览器从缓存中读取，如果不一致，返回 200，浏览器重新下载
- ETag：服务器响应请求时，返回资源的唯一标识，浏览器下次请求时，会带上 If-None-Match，服务器比较这个标识和资源的唯一标识，如果一致，返回 304，浏览器从缓存中读取，如果不一致，返回 200，浏览器重新下载
- 如果同时存在 Last-Modified 和 ETag，浏览器会优先使用 ETag

## HTTP 介绍

### HTTP0.9 1991 年

- 只能发生 get 请求，返回 HTML

### HTTP1.0 1996 年

优化

- 增加了 POST 和 HEAD 请求方式，增加了状态码，增加了 HTTP 头部信息，增加了多字符集支持，增加了缓存，增加了代理和安全性
- 响应体可以是任何类型

缺陷

- 每次请求都要建立 TCP 连接，效率低下
- 每次请求都要带上完整的头部信息，增加了带宽使用

### HTTP1.1 1999 年

优化

- 增加了 PUT, PATCH, OPTIONS, DELETE 请求方式
- 持久连接：固定长度时请求头加上 Content-Length，动态长度时分块传输，最后发送一个空块表示传输完成
- hostName 为必传项
- 摘要和代理认证

缺陷

- 队头阻塞：同时发起多个请求，前面的请求慢，会阻塞后面的请求
- 浏览器会限制并发连接的数量

### HTTP2

核心：减少延迟来提升网络性能

优化

- 二进制格式传输数据：更高效更容易解析，帧的集合称为流在。HTTP/1.1 中，让服务器停止向客户端发送响应的唯一方法是关闭连接，这会导致延迟增加，因为任何连续请求都必须打开新的连接。而在 HTTP/2 中，客户端可以使用 RST_STREAM，停止接收特定流，同时连接仍将打开，其他流仍将发挥作用。
- 多路复用：通过单个连接发出多个异步 HTTP 请求，客户端使用指定的流 id 来识别特定数据包所属的流。
- 头部压缩：使用 HPACK 算法压缩头部信息，减少了头部开销
- 服务器推送：服务器可以在客户端请求一个主资源（如 HTML 页面）时，主动将相关的次要资源（如 CSS、JavaScript 文件、图片等）一并发送给客户端。服务器使用 PUSH_PROMISE 帧来通知客户端即将推送哪些资源。
- 请求优先级：优化多个并发请求的传输顺序
- 安全性：建议使用 HTTPS

缺点

- 丢包后，所有的流都要等待重传，导致延迟增加

### HTTP3

- QUIC 协议：因为想让 QUIC 更容易部署，所以在 UDP 上运行它。
- 改进的多路复用：同时发起多个请求，前面的请求慢或丢失，不会阻塞后面的请求，解决了 TCP 的队头阻塞问题
- 内置加密：默认启用 TLS 1.3，提升安全性

#### QUIC

QUIC 是一种通用传输协议，与 TCP 一样。QUIC 使用 UDP，因此 HTTP/3 也使用 UDP，主要是希望 UDP 能让它们更容易部署，因为互联网上（几乎）所有的设备都已经知道并实现了 UDP。 将传输和加密握手合二为一，节省了一次往返

QUIC 与 TLS 深度集成。
QUIC 支持多个独立的字节流。
QUIC 使用连接 ID：支持转移连接，如由 wifi 切换到 4G，网络不会中断。
QUIC 使用帧。

缺点：

- 平均延迟和丢包率等指标不再容易获得，从而增加了检测和诊断问题的难度
- 加密开销较高
- 使网络更加集中

## HTTP 和 HTTPS

1. 数据加密
   HTTP 明文传输，HTTPS 通过 SSL/TLS 加密后传输，即使被拦截也难以解读。对称加密用于数据传输，非对称加密用于交换密钥

2. 安全性
3. 端口号
   80， 443
4. SEO
   HTTPS 优先排名
5. 使用场景
   HTTPS 适用于所有敏感信息传输的网站和应用
6. 工作原理
   先进行 SSL/TLS 握手，协商加密算法和交换密钥。
   通过加密后的安全通道传输数据。

握手过程
客户端向服务器发送请求，要求建立 SSL 连接。
服务器返回数字证书，包含公钥和服务器身份信息。
客户端验证证书的有效性，并生成一个随机的对称密钥。
客户端使用服务器的公钥加密对称密钥，并发送给服务器。
服务器使用私钥解密，得到对称密钥。
之后的通信使用对称密钥加密，确保数据安全传输。
